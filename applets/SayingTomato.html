<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
"http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
<HEAD>
<TITLE>Inside J2VM Interactive Illustrations - Saying Tomato</TITLE>
<META NAME="description" content="Saying Tomato (Java applet) - A
simulation of the Java virtual machine.">
<META NAME="keywords" content="Java Virtual Machine, Java switch statements">
<META NAME="author" content="Bill Venners">
</HEAD>
<!--BEGIN_ARTIMA_COLOR_SCHEME-->
<BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#000099" VLINK="#009999" ALINK="#CC0000">
<!--END_ARTIMA_COLOR_SCHEME-->
<!--BEGIN_FISH_HEADING--> 
<CENTER>
<IMG src="images/fishhead.gif" alt="Interactive Illustrations for Inside the
Java 2 Virtual Machine">
</CENTER>
<!--END_FISH_HEADING--> 
<!--BEGIN_MAIN_TITLES-->
<FONT face="arial, helvetica" COLOR="#000066">
<FONT size=6>Saying Tomato</FONT><BR>
<FONT size=3>A Simulation of the Java Virtual Machine</FONT><BR>
</FONT>
<!--END_MAIN_TITLES-->
<!--BEGIN_TITLE_UNDERBAR-->
<HR align="left" width="85%">
<!--END_TITLE_UNDERBAR-->
<!--BEGIN_RIGHT_MARGIN_TABLE_TAG-->
<TABLE CELLPADDING="3" CELLSPACING="0" BORDER="0" width="85%">
<TR>
<TD  valign="top" rowspan="100">
<!--END_RIGHT_MARGIN_TABLE_TAG-->
<!--BEGIN_MAIN_BODY-->
<!--BEGIN_II_LINKS-->
<DIV id="links">
<CENTER>
<FONT size="1" face="geneva, arial, sans-serif">
<STRONG>
<A href="index.html">Interactive Illustrations</A>&nbsp;| 
<A href="http://www.artima.com/insidejvm/resources/">Resources Page</A>&nbsp;| 
<A href="http://www.artima.com/insidejvm/blurb.html">Order the Book</A>&nbsp;| 
<A href="ThreeDArray.html">Previous</A>&nbsp;| 
<A href="PlayBall.html">Next</A>&nbsp; 
</STRONG>
</FONT>
</CENTER>
</DIV>
<!--END_II_LINKS-->


<p>The <i>Saying Tomato</i> applet, included below, demonstrates a Java virtual machine executing a sequence of bytecodes. This applet accompanies Chapter 16, &quot;Control Flow,&quot; of <i>Inside the Java 2 Virtual Machine</i>.</p>

<center><p><applet CODE="SayingTomato.class" ARCHIVE="JVMSims.jar"
CODEBASE="JVMSimulators" WIDTH=600 HEIGHT=370><b>For some reason, your browser won't let you view this way cool Java applet.</b></applet></p></center>

<p>The bytecode sequence in the simulation was generated by the <code>javac</code> compiler for the <code>argue()</code> method of the class shown below:
</p>
<pre>
// On CD-ROM in file opcodes/ex1/Struggle.java
class Struggle {

    public final static int TOMAYTO = 0;
    public final static int TOMAHTO = 1;

    static void argue() {

        int say = TOMAYTO;

        for (;;) {

            switch (say) {

            case TOMAYTO:

                say = TOMAHTO;
                break;

            case TOMAHTO:

                say = TOMAYTO;
                break;
            }
        }
    }
}
</pre>
<p>The bytecodes generated by <code>javac</code> for the <code>argue()</code> method are shown here: 
</p>
<pre>
 0 iconst_0      // Push constant 0 (TOMAYTO)
 1 istore_0      // Pop into local var 0: int say = TOMAYTO;
 2 iload_0       // Push key for switch from local var 0
                 // Perform switch statement: switch (say) {...
                 // Low case value is 0, high case value is 1
                 // Default branch offset will goto 2
 3 tableswitch 0 to 1: default=2
          0: 24  // case 0 (TOMAYTO): goto 24
          1: 29  // case 1 (TOMAHTO): goto 29
                 // Note that the next instruction starts at address
                 // 24, which means the tableswitch took up 21 bytes
24 iconst_1      // Push constant 1 (TOMAHTO)
25 istore_0      // Pop into local var 0: say = TOMAHTO
26 goto 2        // Branch unconditionally to 2, top of while loop
29 iconst_0      // Push constant 1 (TOMAYTO)
30 istore_0      // Pop into local var 0: say = TOMAYTO
31 goto 2        // Branch unconditionally to 2, top of while loop
</pre>
<p>The <code>argue()</code> method merely switches the value of <code>say</code> back and forth between <code>TOMAYTO</code> and <code>TOMAHTO</code>. Because the values of <code>TOMAYTO</code> and <code>TOMAHTO</code> were consecutive (<code>TOMAYTO</code> was a 0 and <code>TOMAHTO</code> was a 1), the <code>javac</code> compiler used a <code>tableswitch</code>. The <code>tableswitch</code> is a more efficient instruction than a <code>lookupswitch</code>, and the equivalent <code>lookupswitch</code> instruction would occupy 28 bytes--4 bytes more than <code>tableswitch</code>. 
</p>
<p>It turns out that even if <code>TOMAYTO</code> were a 0 and <code>TOMAHTO</code> were a 2, the <code>javac</code> compiler still would have used a <code>tableswitch</code>, because even with the extra default branch offset in there for a 1, the <code>tableswitch</code> instruction would occupy only 28 bytes--the same number of bytes as the equivalent <code>lookupswitch</code>. Both instructions occupy the same number of bytes, but <code>tableswitch</code> is more efficient, so it is used. As soon as you make <code>TOMAHTO</code> a 3, however, <code>javac</code> starts using a <code>lookupswitch</code>. This is because a <code>tableswitch</code> would now need two default branch offsets in its list (for 1 and 2), which would push its size up to 32 bytes. Thus, a <code>lookupswitch</code> now would require fewer bytes than a <code>tableswitch</code>--so <code>javac</code> chooses the <code>lookupswitch</code>.
</p>
<p>The branch offsets for the case values cause the Java virtual machine to hop down to code that will change the value of the <code>say</code> local variable. The value of <code>say</code> will alternate between <code>TOMAYTO</code> and <code>TOMAHTO</code> indefinitely, until the user aborts the program, thereby calling the whole thing off. 
</p>
<p>To drive the <i>Saying Tomato</i> simulation, use the Step, Reset, Run, and Stop buttons. Each time you press the Step button, the simulator will execute the instruction pointed to by the pc register. If you press the Run button, the simulation will continue with no further coaxing on your part until you press the Stop button. To start the simulation over, press the Reset button. For each step of the simulation, a panel at the bottom of the applet contains an explanation of what the next instruction will do. Happy clicking.
</p>

<p><HR WIDTH=500></p>
<p>
Click here to view a page of links to the <a href="sourcecode.html#jvmsim">source code</a> of the <i>Saying Tomato</i> applet.
</p>


<!--BEGIN_II_LINKS-->
<DIV id="links">
<CENTER>
<FONT size="1" face="geneva, arial, sans-serif">
<STRONG>
<A href="index.html">Interactive Illustrations</A>&nbsp;| 
<A href="http://www.artima.com/insidejvm/resources/">Resources Page</A>&nbsp;| 
<A href="http://www.artima.com/insidejvm/blurb.html">Order the Book</A>&nbsp;| 
<A href="ThreeDArray.html">Previous</A>&nbsp;| 
<A href="PlayBall.html">Next</A>&nbsp; 
</STRONG>
</FONT>
</CENTER>
</DIV>
<!--END_II_LINKS-->
<!--END_MAIN_BODY-->
<!--BEGIN_RIGHT_MARGIN_TABLE_CLOSE-->
</TD>
</TR>
</TABLE>
<!--END_RIGHT_MARGIN_TABLE_CLOSE-->
<!--BEGIN_FOOTER_SEPARATOR-->
<HR width="100%">
<!--END_FOOTER_SEPARATOR-->
<!--BEGIN_FOOTER-->
<TABLE width="100%">
<TR>
<TD align="left">
<FONT size="1" face="geneva, arial, sans-serif">
<!--REG_COPYRIGHT_LINE--><A href="copyright.html">Copyright</A> &copy; 1996-1999 Bill Venners. All Rights Reserved.
</FONT>
</TD>
</TR>
</TABLE>
<!--END_FOOTER-->
</body>
</html>
