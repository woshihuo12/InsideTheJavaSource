<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
"http://www.w3.org/TR/REC-html40/loose.dtd">
<HTML>
<HEAD>
<TITLE>Inside J2VM Interactive Illustrations - Conversion Diversion</TITLE>
<META NAME="description" content="Conversion Diversion (Java applet) - A
simulation of the Java virtual machine.">
<META NAME="keywords" content="Java Virtual Machine, Java type conversion">
<META NAME="author" content="Bill Venners">
</HEAD>
<!--BEGIN_ARTIMA_COLOR_SCHEME-->
<BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#000099" VLINK="#009999" ALINK="#CC0000">
<!--END_ARTIMA_COLOR_SCHEME-->
<!--BEGIN_FISH_HEADING--> 
<CENTER>
<IMG src="images/fishhead.gif" alt="Interactive Illustrations for Inside the
Java 2 Virtual Machine">
</CENTER>
<!--END_FISH_HEADING--> 
<!--BEGIN_MAIN_TITLES-->
<FONT face="arial, helvetica" COLOR="#000066">
<FONT size=6>Conversion Diversion</FONT><BR>
<FONT size=3>A Simulation of the Java Virtual Machine</FONT><BR>
</FONT>
<!--END_MAIN_TITLES-->
<!--BEGIN_TITLE_UNDERBAR-->
<HR align="left" width="85%">
<!--END_TITLE_UNDERBAR-->
<!--BEGIN_RIGHT_MARGIN_TABLE_TAG-->
<TABLE CELLPADDING="3" CELLSPACING="0" BORDER="0" width="85%">
<TR>
<TD  valign="top" rowspan="100">
<!--END_RIGHT_MARGIN_TABLE_TAG-->
<!--BEGIN_MAIN_BODY-->
<!--BEGIN_II_LINKS-->
<DIV id="links">
<CENTER>
<FONT size="1" face="geneva, arial, sans-serif">
<STRONG>
<A href="index.html">Interactive Illustrations</A>&nbsp;| 
<A href="http://www.artima.com/insidejvm/resources/">Resources Page</A>&nbsp;| 
<A href="http://www.artima.com/insidejvm/blurb.html">Order the Book</A>&nbsp;| 
<A href="FibonacciForever.html">Previous</A>&nbsp;| 
<A href="InnerInt.html">Next</A>&nbsp; 
</STRONG>
</FONT>
</CENTER>
</DIV>
<!--END_II_LINKS-->


</p><p>The <i>Conversion Diversion</i> applet, included below, demonstrates a Java virtual machine executing a sequence of bytecodes that performs type conversion. This applet accompanies Chapter 11, &quot;Type Conversion,&quot; of <i>Inside the Java 2 Virtual Machine</i>.</p>

<p><center><applet CODE="ConversionDiversion.class" ARCHIVE="JVMSims.jar"
CODEBASE="JVMSimulators" WIDTH=600 HEIGHT=360><b>For some reason, your browser won't let you view this way cool Java applet.</b></applet></center></p>

<p> The bytecode sequence in the simulation was generated by <code>javac</code> for the <code>Convert()</code> method of the class shown below: 
</p>
<pre>
// On CD-ROM in file opcodes/ex1/Diversion.java
class Diversion {

    static void Convert() {

        byte imByte = 0;
        int imInt = 125;

        for (;;) {
            ++imInt;
            imByte = (byte) imInt;

            imInt *= -1;
            imByte = (byte) imInt;
            imInt *= -1;
        }
    }
}
</pre>
<p>The bytecodes generated by <code>javac</code> for <code>Convert()</code> are shown below:
</p>
<pre>
 0 iconst_0    // Push int constant 0.
 1 istore_0    // Pop to local variable 0, which is
               // imByte: byte imByte = 0;
 2 bipush 125  // Expand byte constant 125 to int and push.
 4 istore_1    // Pop to local variable 1, which
               // is imInt: int imInt = 125;
 5 iinc 1 1    // Increment local variable 1 (imInt) by 1: ++imInt;
 8 iload_1     // Push local variable 1 (imInt).
 9 i2b         // Truncate and sign extend top of stack so it
               // has a valid byte value.
10 istore_0    // Pop to local variable 0 (imByte):
               // imByte = (byte) imInt;
11 iload_1     // Push local variable 1 (imInt) again.
12 iconst_m1   // Push integer -1.
13 imul        // Pop top two ints, multiply, push result.
14 istore_1    // Pop result of multiply to local variable 1 (imInt):
               // imInt *= -1;
15 iload_1     // Push local variable 1 (imInt).
16 i2b         // Truncate and sign extend top of stack so it has
               // a valid byte value.
17 istore_0    // Pop to local variable 0 (imByte):
               // imByte = (byte) imInt;
18 iload_1     // Push local variable 1 (imInt) again.
19 iconst_m1   // Push integer -1.
20 imul        // Pop top two ints, multiply, push result.
21 istore_1    // Pop result of multiply to local variable 1 (imInt):
               // imInt *= -1;
22 goto 5      // Jump back to the iinc instruction: for (;;) {}
</pre>
<p>The <code>Convert()</code> method demonstrates the manner in which the Java virtual machine converts from <code>int</code> to <code>byte</code>. <code>imInt</code> starts out as 125. Each pass through the while loop, it is incremented and converted to a <code>byte</code>. Then it is multiplied by -1 and again converted to a <code>byte</code>. The simulation quickly shows what happens at the edges of the valid range for the <code>byte</code> type. 
</p>
<p>The maximum value for a <code>byte</code> is 127. The minimum value is -128. Values of type <code>int</code> that are within this range convert directly to <code>byte</code>. As soon as the <code>int</code> gets beyond the valid range for <code>byte</code>, however, things get interesting. 
</p>
<p>The Java virtual machine converts an <code>int</code> to a <code>byte</code> by truncating and sign extending. The highest order bit, the "sign bit," of <code>long</code>s, <code>int</code>s, <code>short</code>s, and <code>byte</code>s indicate whether or not the integer value is positive or negative. If the sign bit is zero, the value is positive. If the sign bit is one, the value is negative. Bit 7 of a <code>byte</code> value is its sign bit. To convert an <code>int</code> to a <code>byte</code>, bit 7 of the <code>int</code> is copied to bits 8 through 31. This produces an <code>int</code> that has the same numerical value that the <code>int</code>'s lowest order byte would have if it were interpreted as a <code>byte</code> type. After the truncation and sign extension, the <code>int</code> will contain a valid <code>byte</code> value. 
</p>
<p>The simulation applet shows what happens when an <code>int</code> that is just beyond the valid range for <code>byte</code> types gets converted to a <code>byte</code>. For example, when the <code>imInt</code> variable has a value of 128 (0x00000080) and is converted to <code>byte</code>, the resulting <code>byte</code> value is -128 (0xffffff80). Later, when the <code>imInt</code> variable has a value of -129 (0xffffff7f) and is converted to <code>byte</code>, the resulting <code>byte</code> value is 127 (0x0000007f). 
</p>
<p>To drive the <i>Conversion Diversion</i> simulation, use the Step, Reset, Run, and Stop buttons. Each time you press the Step button, the simulator will execute the instruction pointed to by the pc register. If you press the Run button, the simulation will continue with no further coaxing on your part until you press the Stop button. To start the simulation over, press the Reset button. For each step of the simulation, a panel at the bottom of the applet contains an explanation of what the next instruction will do. Happy clicking.</p>

<p><HR WIDTH=500></p>
<p>
Click here to view a page of links to the <a href="sourcecode.html#jvmsim">source code</a> of the <i>Conversion Diversion</i> applet.
</p>


<!--BEGIN_II_LINKS-->
<DIV id="links">
<CENTER>
<FONT size="1" face="geneva, arial, sans-serif">
<STRONG>
<A href="index.html">Interactive Illustrations</A>&nbsp;| 
<A href="http://www.artima.com/insidejvm/resources/">Resources Page</A>&nbsp;| 
<A href="http://www.artima.com/insidejvm/blurb.html">Order the Book</A>&nbsp;| 
<A href="FibonacciForever.html">Previous</A>&nbsp;| 
<A href="InnerInt.html">Next</A>&nbsp; 
</STRONG>
</FONT>
</CENTER>
</DIV>
<!--END_II_LINKS-->
<!--END_MAIN_BODY-->
<!--BEGIN_RIGHT_MARGIN_TABLE_CLOSE-->
</TD>
</TR>
</TABLE>
<!--END_RIGHT_MARGIN_TABLE_CLOSE-->
<!--BEGIN_FOOTER_SEPARATOR-->
<HR width="100%">
<!--END_FOOTER_SEPARATOR-->
<!--BEGIN_FOOTER-->
<TABLE width="100%">
<TR>
<TD align="left">
<FONT size="1" face="geneva, arial, sans-serif">
<!--REG_COPYRIGHT_LINE--><A href="copyright.html">Copyright</A> &copy; 1996-1999 Bill Venners. All Rights Reserved.
</FONT>
</TD>
</TR>
</TABLE>
<!--END_FOOTER-->
</body>
</html>
